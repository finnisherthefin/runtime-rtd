include Makefile_defs

# protos folders
PROTO = protos
PBC_GEN = $(BUILD)/pbc_gen
PBC_OBJ = $(BUILD)/pbc_obj

PROTOS = $(shell cd $(PROTO) && ls *.proto && cd ..) # list all the protos
PBC_SRCS = $(patsubst %.proto,$(PBC_GEN)/%.pb-c.c, $(PROTOS)) # list of all generated source files by doing a path substitution
PBC_OBJS = $(patsubst $(PBC_GEN)/%.c,$(PBC_OBJ)/%.o, $(PBC_SRCS)) # list of all generated object files by doing a path substitution

COMPONENT_DIRS = dev_handler net_handler executor network_switch shm_wrapper runtime_util logger
OBJ_SUBDIR = $(foreach dir,$(COMPONENT_DIRS),$(OBJ)/$(dir)) # list of subfolders in $(OBJ) for runtime object files
INCLUDE = $(foreach dir,$(COMPONENT_DIRS),-I$(dir)) -I$(PBC_GEN) # list of folders to include in compilation commands

BUILD_DIRS = $(BIN) $(BUILD) $(OBJ) $(PBC_GEN) $(PBC_OBJ) $(OBJ_SUBDIR)

# make list of all source files and corresponding object files
SRCS_ALL = $(foreach dir,$(COMPONENT_DIRS),$(shell find $(dir) -name "*.c"))
OBJS_ALL = $(patsubst %.c,$(OBJ)/%.o, $(SRCS_ALL))

$(info OBJS_ALL is $(OBJS_ALL))
$(info SRCS_ALL is $(SRCS_ALL))
$(info INCLUDE is $(INCLUDE))

.PHONY: all clean protobuf obj

.SECONDARY:

all: protobuf obj

protobuf: $(PBC_OBJS)

obj: $(OBJS_ALL)

# makes runtime object file from runtime source files
# makes the runtime object files in $(OBJ) folder
$(OBJ)/%.o: %.c $(PBC_OBJS) | $(OBJ) $(OBJ_SUBDIR)
	$(CC) $(CFLAGS) $(INCLUDE) -c $< -o $@

# makes the generated protobuf-c object files in the $(PBC_OBJ) folder
$(PBC_OBJ)/%.o: $(PBC_GEN)/%.c | $(PBC_OBJ)
	$(CC) $(CFLAGS) -c $< -o $@

# makes the generated protobuf-c files in the $(PBC_GEN) folder
$(PBC_GEN)/%.pb-c.c: $(PROTO)/%.proto | $(PBC_GEN)
	cd protos && protoc-c --c_out $(HOME)/runtime/$(PBC_GEN) $*.proto

# makes build directories if needed
$(BUILD_DIRS):
	mkdir -p $@

# removes all build directories
clean:
	rm -rf $(BUILD_DIRS)
